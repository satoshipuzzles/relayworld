<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relay World - A Nostr Adventure Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/game.css">
    <link rel="stylesheet" href="css/ui.css">
    <link rel="stylesheet" href="css/animations.css">
    <!-- Add these CSS files -->
    <link rel="stylesheet" href="css/login-fixes.css">
    <link rel="stylesheet" href="css/wallet-toast.css">
    <link rel="icon" type="image/png" href="assets/icons/favicon.png">
    <meta name="description" content="Relay World: An interactive multiplayer game powered by Nostr protocol">
    <!-- Add Bitcoin Connect Script -->
    <script src="https://cdn.jsdelivr.net/npm/@getalby/bitcoin-connect@3.5.3/dist/index.browser.js"></script>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas" width="800" height="600"></canvas>
        <div id="weather-overlay" class="weather-effect"></div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-container">
        <!-- Login Screen -->
        <div id="login-screen">
            <div id="login-panel">
                <div class="pixel-corner corner-tl"></div>
                <div class="pixel-corner corner-tr"></div>
                <div class="pixel-corner corner-bl"></div>
                <div class="pixel-corner corner-br"></div>
                <div class="triforce-container">
                    <div class="triforce top"></div>
                    <div class="triforce left"></div>
                    <div class="triforce right"></div>
                </div>
                <h1>Relay World</h1>
                <p>EMBARK ON A NOSTR ADVENTURE</p>
                <p>A digital adventure awaits! Explore the Nostr network in a vibrant 8-bit world.</p>
                
                <!-- Login options -->
                <div id="login-options">
                    <button id="login-button" class="primary-button">CONNECT WITH NOSTR</button>
                    <div class="login-extras hide">
                        <div class="separator">AFTER LOGGING IN</div>
                        <button id="login-nwc" class="secondary-button">CONNECT LIGHTNING WALLET</button>
                    </div>
                </div>
                
                <div class="loader hide" id="login-loader"></div>
                <div id="login-status"></div>
                <div class="instructions">
                    <h3>QUEST GUIDE</h3>
                    <p><strong>MOVEMENT:</strong> WASD or Arrow Keys</p>
                    <p><strong>INTERACT:</strong> E or Space near users</p>
                    <p><strong>CHAT:</strong> Enter for global chat, V for voice</p>
                    <p><strong>ZAP:</strong> Z to zap nearby players</p>
                    <p><strong>GOAL:</strong> Explore, connect, and build your legend!</p>
                </div>
            </div>
            <div class="sound-wave" id="sound-wave"></div>
        </div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hide">
            <h3>Loading Relay World</h3>
            <div class="spinner"></div>
            <p id="loading-status">Connecting to relay...</p>
        </div>

        <!-- Top Bar -->
        <div id="top-bar" class="hide">
            <div id="score-display">Score: 0</div>
            <div id="game-controls">
                <div class="relay-controls">
                    <div class="relay-group">
                        <label for="relay-selector">Explorer Relay:</label>
                        <select id="relay-selector">
                            <option value="" disabled>Select Explorer Relay</option>
                        </select>
                        <button id="relay-info-button" class="icon-button" title="Relay Info">‚ÑπÔ∏è</button>
                    </div>
                    <div class="custom-relay">
                        <input type="text" id="custom-relay-input" placeholder="wss://your-relay.com">
                        <button id="add-relay-button" class="pixel-button">Add Explorer</button>
                    </div>
                </div>
                
                <div id="dm-notification" class="hide">
                    <span id="unread-count" class="badge">0</span>
                    <button id="open-dm-button" class="icon-button" title="Messages">‚úâÔ∏è</button>
                </div>

                <div id="voice-controls">
                    <button id="voice-toggle" class="icon-button"><span id="voice-icon">üéôÔ∏è</span></button>
                    <div id="voice-indicator"></div>
                </div>
            </div>
        </div>

        <!-- Player Profile -->
        <div id="player-profile" class="hide">
            <div id="player-profile-header">
                <img id="player-profile-image" src="assets/icons/default-avatar.png" alt="Profile">
                <div id="player-profile-details">
                    <div id="player-profile-name">Loading...</div>
                    <div id="player-profile-npub">Loading...</div>
                    <div id="player-profile-title"></div>
                </div>
            </div>
            <div id="player-profile-stats">
                <div class="profile-stat"><div class="label">Level:</div><div class="value" id="profile-level">1</div></div>
                <div class="profile-stat"><div class="label">Score:</div><div class="value" id="profile-score">0</div></div>
                <div class="profile-stat"><div class="label">Items:</div><div class="value" id="profile-items">0</div></div>
                <div class="profile-stat"><div class="label">Interactions:</div><div class="value" id="profile-interactions">0</div></div>
                <div class="profile-stat"><div class="label">Zaps:</div><div class="value" id="profile-zaps">0</div></div>
            </div>
            <div id="player-actions">
                <button id="inventory-button" class="action-button">Inventory</button>
                <button id="shop-button" class="action-button">Shop</button>
                <button id="guild-button" class="action-button">Guild</button>
                <button id="pet-button" class="action-button">Pet</button>
                <button id="achievements-button" class="action-button">Achievements</button>
                <button id="settings-button" class="action-button">Settings</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div id="leaderboard-container" class="hide">
            <h3>Leaderboard</h3>
            <div id="leaderboard-tabs">
                <button class="tab-button active" data-type="score">Score</button>
                <button class="tab-button" data-type="items">Items</button>
                <button class="tab-button" data-type="quests">Quests</button>
                <button class="tab-button" data-type="zaps">Zaps</button>
            </div>
            <div id="leaderboard-entries"></div>
        </div>

        <!-- User Popup -->
        <div id="user-popup" class="hide" data-pubkey="">
            <div id="user-popup-header">
                <img id="user-popup-image" src="assets/icons/default-avatar.png" alt="User">
                <div id="user-popup-details">
                    <div id="user-popup-name">Loading...</div>
                    <div id="user-popup-npub">Loading...</div>
                </div>
                <button id="user-popup-close">√ó</button>
            </div>
            <div id="user-popup-actions">
                <button class="user-popup-button" id="follow-button">Follow</button>
                <button class="user-popup-button" id="chat-button">Chat</button>
                <button class="user-popup-button" id="voice-chat-button">Voice</button>
                <button class="user-popup-button" id="trade-button">Trade</button>
                <button class="user-popup-button" id="zap-button">Zap</button>
            </div>
            <div id="user-stats-container">
                <h4>Stats</h4>
                <div class="user-stats">
                    <div class="user-stat">
                        <span class="label">Level:</span>
                        <span class="value" id="user-level">1</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Score:</span>
                        <span class="value" id="user-score">0</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Guild:</span>
                        <span class="value" id="user-guild">None</span>
                    </div>
                    <div class="user-stat">
                        <span class="label">Achievements:</span>
                        <span class="value" id="user-achievements">0</span>
                    </div>
                </div>
            </div>
            <div id="user-notes-container">
                <h4>Recent Notes</h4>
                <div id="user-notes"></div>
            </div>
        </div>

        <!-- Chat Container -->
        <div id="chat-container" class="hide">
            <div id="chat-messages"></div>
            <div class="chat-input-wrapper">
                <input type="text" id="chat-input" placeholder="Type a message...">
                <button id="send-chat-button">Send</button>
            </div>
        </div>

        <!-- Direct Messages Modal -->
        <div id="dm-modal" class="hide">
            <div class="dm-header">
                <h3>Direct Messages</h3>
                <button id="dm-close">√ó</button>
            </div>
            <div class="dm-sidebar">
                <div class="dm-search">
                    <input type="text" id="dm-search-input" placeholder="Search conversations...">
                </div>
                <div class="dm-conversations"></div>
                <button id="new-dm-button" class="primary-button">New Message</button>
            </div>
            <div class="dm-content">
                <div class="dm-messages"></div>
                <div class="dm-input-area">
                    <textarea id="dm-input" placeholder="Type a secure message..."></textarea>
                    <div class="dm-actions">
                        <button id="dm-attach-button" class="icon-button" title="Attach File">üìé</button>
                        <button id="dm-send-button" class="primary-button">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Controls -->
        <div id="mobile-controls" class="hide">
            <div id="mobile-control-up" class="mobile-control-button">‚Üë</div>
            <div id="mobile-control-down" class="mobile-control-button">‚Üì</div>
            <div id="mobile-control-left" class="mobile-control-button">‚Üê</div>
            <div id="mobile-control-right" class="mobile-control-button">‚Üí</div>
            <div id="mobile-control-action" class="mobile-control-button">A</div>
        </div>

        <!-- Quest Display -->
        <div id="quest-display" class="hide"></div>
        
        <!-- Mini Map -->
        <canvas id="mini-map" width="150" height="150" class="hide"></canvas>
        
        <!-- Proximity Voice Chat Indicators -->
        <div id="voice-chat-indicators"></div>
        
        <!-- Toast Notifications -->
        <div id="toast-container"></div>
        
        <!-- Inventory Interface -->
        <div id="inventory-interface" class="hide">
            <div id="inventory-header">
                <h3>Inventory</h3>
                <button id="inventory-close">√ó</button>
            </div>
            <div id="inventory-tabs">
                <button class="tab-button active" data-tab="items">Items</button>
                <button class="tab-button" data-tab="equipment">Equipment</button>
                <button class="tab-button" data-tab="collectibles">Collectibles</button>
            </div>
            <div id="inventory-content"></div>
        </div>

        <!-- Marketplace Interface -->
        <div id="marketplace-interface" class="hide">
            <div id="marketplace-header">
                <h3>Marketplace</h3>
                <button id="marketplace-close">√ó</button>
            </div>
            <div id="marketplace-tabs">
                <button class="tab-button active" data-tab="browse">Browse</button>
                <button class="tab-button" data-tab="my-listings">My Listings</button>
                <button class="tab-button" data-tab="history">History</button>
            </div>
            <div id="marketplace-content"></div>
        </div>

        <!-- Guild Interface -->
        <div id="guild-interface" class="hide">
            <div id="guild-header">
                <h3>Guild</h3>
                <button id="guild-close">√ó</button>
            </div>
            <div id="guild-content"></div>
        </div>

        <!-- Achievements Interface -->
        <div id="achievements-interface" class="hide">
            <div id="achievements-header">
                <h3>Achievements</h3>
                <button id="achievements-close">√ó</button>
            </div>
            <div id="achievements-content"></div>
        </div>

        <!-- Zap Interface -->
        <div id="zap-interface" class="hide">
            <div id="zap-header">
                <h3>Zap Player</h3>
                <button id="zap-close">√ó</button>
            </div>
            <div id="zap-content">
                <div class="zap-target">
                    <img id="zap-target-image" src="assets/icons/default-avatar.png">
                    <div id="zap-target-name">Target Name</div>
                </div>
                <div class="zap-amount-container">
                    <div class="zap-presets">
                        <button class="zap-preset" data-amount="21">21 ‚ö°</button>
                        <button class="zap-preset" data-amount="210">210 ‚ö°</button>
                        <button class="zap-preset" data-amount="2100">2100 ‚ö°</button>
                    </div>
                    <div class="zap-custom">
                        <input type="number" id="zap-amount" placeholder="Custom amount" min="1" value="21">
                        <span class="zap-unit">sats</span>
                    </div>
                </div>
                <textarea id="zap-message" placeholder="Add a message (optional)"></textarea>
            </div>
            <button id="zap-send-button" class="primary-button">Send Zap</button>
        </div>

        <!-- Bitcoin Connect Modal -->
        <div id="bitcoin-connect-modal" class="hide">
            <div id="bc-modal-content">
                <div id="bc-modal-header">
                    <h3 id="bc-modal-title">Connect Lightning Wallet</h3>
                    <button id="bc-modal-close">√ó</button>
                </div>
                <div id="bc-connector-list">
                    <div class="bc-connector" data-connector="nwc">
                        <img class="bc-connector-icon" src="assets/icons/nwc.png" alt="NWC">
                        <div class="bc-connector-name">Nostr Wallet Connect</div>
                    </div>
                    <div class="bc-connector" data-connector="alby">
                        <img class="bc-connector-icon" src="assets/icons/alby.png" alt="Alby">
                        <div class="bc-connector-name">Alby Extension</div>
                    </div>
                    <div class="bc-connector" data-connector="webln">
                        <img class="bc-connector-icon" src="assets/icons/webln.png" alt="WebLN">
                        <div class="bc-connector-name">WebLN Compatible</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DM Inbox Configuration -->
        <div id="dm-inbox-config-modal" class="hide">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Configure DM Inbox</h3>
                    <button id="dm-inbox-config-close">√ó</button>
                </div>
                <div class="modal-body">
                    <p>To receive direct messages, you need to publish your preferred inbox relays.</p>
                    <p>Select up to 3 relays:</p>
                    <div id="dm-inbox-relays"></div>
                    <button id="dm-inbox-add-relay-button" class="secondary-button">Add Custom Relay</button>
                    <div id="dm-inbox-custom-relay" class="hide">
                        <input type="text" id="dm-inbox-custom-relay-input" placeholder="wss://your-relay.com">
                        <button id="dm-inbox-custom-relay-add" class="pixel-button">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="dm-inbox-publish-button" class="primary-button">Publish Inbox Configuration</button>
                </div>
            </div>
        </div>
        
        <!-- Wallet balance display -->
        <div id="wallet-balance-display" class="hide"></div>
    </div>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/nostr-tools/lib/nostr.bundle.js"></script>
    <script src="https://unpkg.com/simple-peer/simplepeer.min.js"></script>
    
    <!-- Game Scripts - Using ES modules -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Fix scripts -->
    <script src="js/login-fix.js"></script>
    <script src="js/wallet-connection-fix.js"></script>
    <script src="js/direct-fix.js"></script>
</body>
</html>
